!function(){"use strict";var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return function(e,t){this.x1=e,this.y1=t}}(),r=function(){return function(){}}(),o=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Yellow",t.turn=3,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e-n,t-r]},n}(r),i=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Green",t.turn=4,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e-r,t+n]},n}(r),a=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Blue",t.turn=2,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e+r,t-n]},n}(r),u=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Dead",t.turn=0,t}return t(n,e),n.prototype.rotate=function(e,t){throw new Error("Not implemented")},n}(r),s=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Red",t.turn=1,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e+n,t+r]},n}(r),c=function(){function e(e,t){return this.m=e,this.n=t,this}return e.prototype.char=function(e){return String.fromCharCode(e+97)},e.prototype.code=function(){return""+this.char(this.n)+(this.m+1)},e.prototype.accessible=function(){return this.m>=3&&this.m<=10&&this.n>=0&&this.n<=2||this.m>=0&&this.m<=13&&this.n>=3&&this.n<=10||this.m>=3&&this.m<=10&&this.n>=11&&this.n<=13},e.coords=function(e){return[parseInt(e.slice(1))-1,e.charCodeAt(0)-97]},e}(),f=function(){function e(e,t){this.player=this.createPlayer(e),this.coords=c.coords(t),this.counter=0,this.dp=e}return e.prototype.moved=function(){for(var e=!0,t=0;t<this.home.length;t++){var n=this.home[t][0]-6.5,r=this.home[t][1]-6.5,o=this.player.rotate(6.5,6.5,r,n),i=o[0],a=o[1];if(this.coords[1]===i&&this.coords[0]===a){e=!1;break}}return e},e.prototype.radius=function(){for(;!this.max||this.counter<this.max;)return this.counter++,{value:this.counter,done:!1};return this.counter=0,{value:void 0,done:!0}},e.prototype.createPlayer=function(e){switch(e.charAt(0)){case"w":return new s;case"g":return new a;case"b":return new o;case"r":return new i;case"d":return new u;default:return}},e}(),l=function(e){function r(t,n){var r=e.call(this,t,n)||this;return r.name="Knight",r.home=[[0,4],[0,9]],r.max=1,r}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return 2},function(e){return 1}),!0],[new n(function(e){return 2},function(e){return-1}),!0],[new n(function(e){return-2},function(e){return 1}),!0],[new n(function(e){return-2},function(e){return-1}),!0],[new n(function(e){return 1},function(e){return 2}),!0],[new n(function(e){return 1},function(e){return-2}),!0],[new n(function(e){return-1},function(e){return 2}),!0],[new n(function(e){return-1},function(e){return-2}),!0]]},r}(f),d=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Bishop",t.home=[[0,5],[0,8]],t}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return e}),!0],[new n(function(e){return e},function(e){return-e}),!0],[new n(function(e){return-e},function(e){return e}),!0],[new n(function(e){return-e},function(e){return-e}),!0]]},r}(f),p=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Queen",t.home=t.player instanceof s||t.player instanceof o?[[0,6]]:[[0,7]],t}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return 0}),!0],[new n(function(e){return-e},function(e){return 0}),!0],[new n(function(e){return 0},function(e){return e}),!0],[new n(function(e){return 0},function(e){return-e}),!0],[new n(function(e){return e},function(e){return e}),!0],[new n(function(e){return e},function(e){return-e}),!0],[new n(function(e){return-e},function(e){return e}),!0],[new n(function(e){return-e},function(e){return-e}),!0]]},r}(f),h=function(e){function r(t,n){var r=e.call(this,t,n)||this;return r.name="King",r.home=r.player instanceof s||r.player instanceof o?[[0,7]]:[[0,6]],r.max=1,r}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return 1},function(e){return 0}),!0],[new n(function(e){return-1},function(e){return 0}),!0],[new n(function(e){return 0},function(e){return 1}),!0],[new n(function(e){return 0},function(e){return-1}),!0],[new n(function(e){return 1},function(e){return 1}),!0],[new n(function(e){return 1},function(e){return-1}),!0],[new n(function(e){return-1},function(e){return 1}),!0],[new n(function(e){return-1},function(e){return-1}),!0]]},r}(f),v=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Rook",t.home=[[0,3],[0,10]],t}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return 0}),!0],[new n(function(e){return-e},function(e){return 0}),!0],[new n(function(e){return 0},function(e){return e}),!0],[new n(function(e){return 0},function(e){return-e}),!0]]},r}(f),m=function(e){function r(t,n){var r=e.call(this,t,n)||this;return r.name="Pawn",r.home=[[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9],[1,10]],r.max=1,r}return t(r,e),r.prototype.moves=function(){return this.moved()?[[new n(function(e){return 0},function(e){return 1}),!0]]:[[new n(function(e){return 0},function(e){return 1}),!0],[new n(function(e){return 0},function(e){return 2}),!0]]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return e}),!0],[new n(function(e){return-e},function(e){return e}),!0]]},r}(f),y=function(){function e(){this.squares=[];for(var e=0;e<14;e++){this.squares[e]=[];for(var t=0;t<14;t++)this.squares[e][t]=new c(e,t)}}return e.prototype.square=function(e){var t=c.coords(e);return this.squares[t[0]][t[1]]},e.prototype.valid=function(e,t){return e>=0&&e<=13&&t>=0&&t<=13},e}(),g=function(){function e(){this.colours=["red","blue","yellow","green"],this.board=new y;var e=this.getUsername();this.username=e||"red"}return e.prototype.setOriginSquare=function(e){var t=this.getThisSquareElement(event.target);if(t){var n=t.attributes["data-square"];if(n){var r=document.getElementById("four-player-username"),o=r.attributes.origin;o?o.value=n.value:r.setAttribute("origin",n.value)}}},e.prototype.getOriginSquareElement=function(){var e=document.getElementById("four-player-username").attributes.origin;if(e)return this.board.square(e.value).element},e.prototype.resetOriginSquareAndCleanSquares=function(){var e=document.getElementById("four-player-username");e.attributes.origin&&e.removeAttribute("origin");var t=this.getBoardElement();this.createBoard(t),this.clearCandidatesFromSquares(),this.cleanColouredSquares()},e.prototype.showMovesAndEnemies=function(e){if(this.username){var t=this.getBoardElement();if(t){this.createBoard(t);var n=this.getOriginSquareElement();if(n){var r=this.getThisSquareElement(e);if(r){this.clearCandidatesFromSquares(),this.cleanColouredSquares();var o=n.attributes["data-square"];if(o){var i=this.board.square(o.value);i.piece&&i.piece.player.name.toLowerCase()===this.username&&(this.analyseSquares(),this.colouriseSquares(t,n,r))}}}}}},e.prototype.showHangingPieces=function(){var e=this.getBoardElement();e&&(this.createBoard(e),this.clearCandidatesFromSquares(),this.cleanColouredSquares(),this.analyseSquares(),this.colouriseSquaresWithHangingPieces())},e.prototype.getThisSquareElement=function(e){var t;if(e instanceof HTMLElement&&(-1!==e.className.indexOf("piece-")&&(t=e.parentElement),t||(t=e),-1!==t.className.indexOf("square-")&&t instanceof HTMLDivElement))return t},e.prototype.getHtmlDivElementArray=function(){return[].slice.call(document.body.getElementsByTagName("div"))},e.prototype.getBoardElement=function(){return this.getHtmlDivElementArray().filter(function(e){return 0===e.className.indexOf("board-")})[0]},e.prototype.cleanColouredSquares=function(){var e=document.getElementById("four-player-username"),t=e.attributes.modifications;if(t){for(var n=t.value.split(","),r=0;r<n.length;r++){this.board.square(n[r]).element.style.backgroundColor=null}e.removeAttribute("modifications")}},e.prototype.clearCandidatesFromSquares=function(){for(var e=0;e<14;e++)for(var t=0;t<14;t++){var n=this.board.squares[e][t];n.element.attributes.attacks&&n.element.removeAttribute("attacks"),n.element.attributes.moves&&n.element.removeAttribute("moves")}},e.prototype.createBoard=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var o=t[n].children[r];if(o instanceof HTMLDivElement){var i=o.attributes["data-square"];if(i){var a=this.board.square(i.value),u=this.getPieceElement(o.children);if(u){var s=u.attributes["data-piece"];s&&(a.piece=this.createPiece(s.value,i.value))}a.element=o}}}},e.prototype.createPiece=function(e,t){switch(e.charAt(1)){case"R":return new v(e,t);case"P":return new m(e,t);case"K":return new h(e,t);case"Q":case"D":return new p(e,t);case"B":return new d(e,t);case"N":return new l(e,t);default:return}},e.prototype.analyseSquares=function(){for(var e=0;e<14;e++)for(var t=0;t<14;t++){var n=this.board.squares[e][t];if(n.accessible()){var r=n.piece;r&&(r.player instanceof u||this.checkRadius(n))}}},e.prototype.checkRadius=function(e){this.checkAttackRadius(e),this.checkMoveRadius(e)},e.prototype.checkAttackRadius=function(e){for(var t=e.piece,n=t.attacks(),r=t.radius();!r.done&&r.value<=14&&this.remaining(n)>0;){for(var o=0;o<n.length;o++)this.checkAttackVector(e,n[o],r.value);r=t.radius()}},e.prototype.checkMoveRadius=function(e){for(var t=e.piece,n=t.moves(),r=t.radius();!r.done&&r.value<=14&&this.remaining(n)>0;){for(var o=0;o<n.length;o++)this.checkMoveVector(e,n[o],r.value);r=t.radius()}},e.prototype.checkAttackVector=function(e,t,n){if(t[1]){var r=t[0].x1(n),o=t[0].y1(n),i=e.piece.player.rotate(e.n,e.m,r,o),a=i[0],u=i[1];if(!this.board.valid(a,u))return void(t[1]=!1);var s=this.board.squares[u][a];if(!s.accessible())return void(t[1]=!1);this.setAttackCandidate(e,s),s.piece&&(t[1]=!1)}},e.prototype.checkMoveVector=function(e,t,n){if(t[1]){var r=t[0].x1(n),o=t[0].y1(n),i=e.piece.player.rotate(e.n,e.m,r,o),a=i[0],u=i[1];if(!this.board.valid(a,u))return void(t[1]=!1);var s=this.board.squares[u][a];if(!s.accessible())return void(t[1]=!1);s.piece?t[1]=!1:this.setMoveCandidate(e,s)}},e.prototype.setAttackCandidate=function(e,t){var n=t.element.attributes.attacks;n?n.value=n.value+","+e.code():t.element.setAttribute("attacks",e.code())},e.prototype.setMoveCandidate=function(e,t){var n=t.element.attributes.moves;n?n.value=n.value+","+e.code():t.element.setAttribute("moves",e.code())},e.prototype.isTargetSquareValid=function(e,t,n){if(e.children.length<14)return!1;var r=t.attributes["data-square"];if(!r)return!1;var o,i=this.board.square(r.value).piece;if(!i)return!1;if(i.moves().length>0){var a=n.attributes.moves;if(!a)return!1;o=a.value.split(",")}else{var u=n.attributes.attacks;if(!u)return!1;o=u.value.split(",")}return 0!==o.length&&-1!==o.indexOf(r.value)},e.prototype.colouriseSquares=function(e,t,n){var r=e.children;r.length<14||(this.colouriseMovementSquares(r,e,t),this.isTargetSquareValid(e,t,n)&&this.colouriseEnemySquares(r,n))},e.prototype.colouriseMovementSquares=function(e,t,n){var r=n.attributes["data-square"];if(r){var o=this.board.square(r.value).piece;if(o)for(var i=0;i<14;i++)for(var a=0;a<14;a++){var u=e[i].children[a],s=u.attributes["data-square"];if(s&&u instanceof HTMLElement){var c=this.board.square(s.value);if(!c.piece||c.piece.player.name.toLowerCase()!==this.username){var f=void 0;if(0!==o.moves().length){var l=u.attributes.moves;if(!l)continue;f=l.value.split(",")}else{var d=u.attributes.attacks;if(!d)continue;f=d.value.split(",")}if(0!==f.length&&-1!==f.indexOf(r.value)){var p=[],h=u.attributes.attacks;h&&(p=h.value.split(","));var v=p.indexOf(r.value);-1!==v&&p.splice(v,1);var m=this.isFriendlySquare(p),y=this.getColour(u,m);u.style.backgroundColor=y,this.addCodeToModifiedSquares(s.value)}}}}}},e.prototype.colouriseEnemySquares=function(e,t){var n=t.attributes.attacks;if(n){var r=n.value.split(",");if(0!=r.length){var o=t.attributes["data-square"];if(o){var i=r.indexOf(o.value);-1!==i&&r.splice(i,1);for(var a=0;a<r.length;a++){var u=this.board.square(r[a]),s=e[13-u.m].children[u.n];if(s instanceof HTMLElement){var c=u.piece;if(c&&c.player.name.toLowerCase()!==this.username){var f=this.getColour(s,!1);s.style.backgroundColor=f,this.addCodeToModifiedSquares(r[a])}}}}}}},e.prototype.colouriseSquaresWithHangingPieces=function(){for(var e=0;e<14;e++)for(var t=0;t<14;t++){var n=this.board.square[e][t],r=n.piece;if(r&&!(r.player instanceof u)){var o=void 0,i=n.element.attributes.attacks;if(i){var a=i.value.split(",");o=!this.isSquareCovered(r.player,a)}else o=!this.isSquareEnclosed(n);if(o){var s=this.getColour(n.element,!1);n.element.style.backgroundColor=s}}}},e.prototype.isSquareEnclosed=function(e){for(var t=-1;t<=1;t++)for(var n=-1;n<=1;n++)if((0!==t||0!==n)&&this.board.valid(e.n+t,e.m+n)){var r=this.board.squares[e.m+n][e.n+t];if(r.accessible()){if(!r.piece)return!1;if(r.piece.player.name!==e.piece.player.name)return!1}}return!0},e.prototype.isSquareCovered=function(e,t){for(var n=0;n<t.length;n++){var r=this.board.square(t[n]).piece;if(r&&r.player.name===e.name)return!0}return!1},e.prototype.isFriendlySquare=function(e){for(var t=0,n=0,r=0;r<e.length;r++){var o=this.board.square(e[r]).piece;o&&(o.player.name.toLowerCase()===this.username?t++:n++)}return 0===t&&0===n||t>n},e.prototype.getColour=function(e,t){var n,r=window.getComputedStyle(e,null).getPropertyValue("background-color");if(0===r.indexOf("#")&&(n=this.hexToRgb(r)),0===r.indexOf("rgb")){var o=r.substring(4,r.length-1).split(", ");n={r:parseInt(o[0]),g:parseInt(o[1]),b:parseInt(o[2])}}return t?"rgb("+n.r+", 255, "+n.b+")":"rgb(255, "+n.g+", "+n.b+")"},e.prototype.addCodeToModifiedSquares=function(e){var t=document.getElementById("four-player-username"),n=t.attributes.modifications;n?n.value=n.value+","+e:t.setAttribute("modifications",e)},e.prototype.show=function(){for(var e=0;e<14;e++){for(var t=["|"],n=0;n<14;n++){var r=this.board.squares[e][n];r.accessible()?t.push(r.piece?r.piece.dp:"[]"):t.push("  ")}t.push("|");var o=this.board.squares;console.log(t.join(" ")+"%O %O %O %O %O %O %O %O %O %O %O %O %O %O |",o[e][0],o[e][1],o[e][2],o[e][3],o[e][4],o[e][5],o[e][6],o[e][7],o[e][8],o[e][9],o[e][10],o[e][11],o[e][12],o[e][13])}},e.prototype.getUsername=function(){for(var e=document.getElementById("four-player-username").innerText,t=document.body.getElementsByClassName("player-avatar"),n=0;n<t.length;n++){var r=t[n];if(r instanceof HTMLAnchorElement&&-1!==r.href.indexOf(e))for(var o=r.parentElement,i=0;i<o.classList.length;i++)for(var a=0;a<this.colours.length;a++)if(this.colours[a]===o.classList[i])return this.colours[a]}},e.prototype.hexToRgb=function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,n,r){return t+t+n+n+r+r});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},e.prototype.remaining=function(e){for(var t=0,n=0;n<e.length;n++)e[n][1]&&t++;return t},e.prototype.getPieceElement=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&0===n.className.indexOf("piece-"))return n}},e}(),b=function(){function e(){this.counter=60,this.enabled=!1,this.utterances=[60]}return e.prototype.username=function(){return document.getElementById("four-player-username").innerText},e.prototype.avatar=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&n.classList.contains("player-avatar"))return n}},e.prototype.current=function(e){return parseFloat(e.oldValue.trim().split(":")[1])},e.prototype.reset=function(e){if("childList"===e.type&&e.target instanceof HTMLDivElement&&0===e.target.classList.length&&1===e.addedNodes.length){var t=e.addedNodes[0];if(t instanceof HTMLElement&&t.classList.contains("modal-container"))t.querySelector(".game-over-container")&&(this.utterances=[60],this.counter=60)}},e.prototype.words=function(){return this.counter<=5?this.counter.toString():this.counter+" seconds left"},e.prototype.utterance=function(){return this.rate(new SpeechSynthesisUtterance(this.words()))},e.prototype.rate=function(e){return e.rate=1.8,e},e.prototype.utter=function(e){if(this.enabled&&"characterData"===e.type){var t=e.target.parentNode.parentNode;if(t&&t instanceof HTMLElement&&t.classList.contains("player-clock-timer")){var n=this.avatar(t.children);if(n&&n instanceof HTMLAnchorElement&&n.pathname==="/member/"+this.username()){var r=this.current(e);this.counter-r>0&&this.counter-r<=1&&(this.counter=r),(this.counter<=5&&this.counter%1==0||this.counter>5&&this.counter%5==0)&&this.counter!==this.utterances[0]&&(window.speechSynthesis.speak(this.utterance()),this.utterances.unshift(this.counter))}}}},e}(),w=function(){function e(){this.countdown=new b,this.init={characterDataOldValue:!0,attributeOldValue:!0,characterData:!0,attributes:!0,childList:!0,subtree:!0},document.records=[],this.createDocumentBodyObserverSubscription(),this.observer.observe(document.body,this.init)}return e.prototype.createDocumentBodyObserverSubscription=function(){var e=this;this.observer=new MutationObserver(function(t){t.forEach(function(t){e.checkForBoardUpdate(t),e.countdown.reset(t),e.countdown.utter(t)})})},e.prototype.checkForBoardUpdate=function(e){document.records.push(e),"childList"===e.type&&e.target instanceof HTMLElement&&0===e.target.className.indexOf("board-")&&(new g).showHangingPieces()},e}();new(function(){function e(){document.body.addEventListener("mouseover",this.over),document.body.addEventListener("mousedown",this.down),document.body.addEventListener("mouseup",this.up),window.addEventListener("keydown",function(e){(!e.repeat&&"q"===e.key||"Q"===e.key)&&console.log("q key pressed")}),window.addEventListener("keyup",function(e){"q"!==e.key&&"Q"!==e.key||console.log("q key released")}),this.domWatcher=new w,this.rightAlignStartButton(),this.addStartAiButton()}return e.prototype.addStartAiButton=function(){var e=this,t=document.getElementsByClassName("btns-container")[0];if(t instanceof HTMLElement){t.style.cssFloat="right";var n=t.cloneNode(!0);if(n instanceof HTMLElement){n.style.cssFloat="left",n.style.marginRight="12px";var r=n.firstChild;"A"===r.nodeName&&r instanceof HTMLElement&&(r.innerText="Start AI",r.classList.remove("new-game-btn"));var o=n.cloneNode(!0);if(o instanceof HTMLElement){o.style.display="none";var i=o.firstChild;"A"===i.nodeName&&i instanceof HTMLElement&&(i.innerText="Stop AI",i.style.color="#b4b4b3",i.style.borderBottom="#272422",i.style.backgroundColor="#272422",i.addEventListener("click",function(){e.domWatcher.countdown.enabled=!1,o.style.display="none",n.style.display="block"})),r.addEventListener("click",function(){e.domWatcher.countdown.enabled=!0,o.style.display="block",n.style.display="none"})}t.parentNode.appendChild(n),t.parentNode.appendChild(o)}}return this},e.prototype.rightAlignStartButton=function(){var e=document.getElementsByTagName("head")[0];if(e instanceof HTMLElement){var t=document.createTextNode(".btns-container { float: right; }"),n=document.createElement("style");n instanceof HTMLElement&&(n.type="text/css",n.appendChild(t)),e.appendChild(n)}return this},e.prototype.over=function(e){(new g).showMovesAndEnemies(e.target)},e.prototype.down=function(e){var t=new g;t.setOriginSquare(e.target),t.showMovesAndEnemies(e.target)},e.prototype.up=function(e){var t=new g;t.resetOriginSquareAndCleanSquares(),t.showHangingPieces()},e}())}();
