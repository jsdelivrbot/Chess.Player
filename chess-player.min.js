!function(){"use strict";var e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}var n=function(){return function(e,t){this.x1=e,this.y1=t}}(),r=function(){return function(){}}(),i=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Yellow",t.turn=3,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e-n,t-r]},n}(r),o=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Green",t.turn=4,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e-r,t+n]},n}(r),a=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Blue",t.turn=2,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e+r,t-n]},n}(r),u=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Dead",t.turn=0,t}return t(n,e),n.prototype.rotate=function(e,t){throw new Error("Not implemented")},n}(r),s=function(e){function n(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Red",t.turn=1,t}return t(n,e),n.prototype.rotate=function(e,t,n,r){return[e+n,t+r]},n}(r),c=function(){function e(e,t){return this.m=e,this.n=t,this}return e.prototype.char=function(e){return String.fromCharCode(e+97)},e.prototype.code=function(){return""+this.char(this.n)+(this.m+1)},e.prototype.accessible=function(){return this.m>=3&&this.m<=10&&this.n>=0&&this.n<=2||this.m>=0&&this.m<=13&&this.n>=3&&this.n<=10||this.m>=3&&this.m<=10&&this.n>=11&&this.n<=13},e.coords=function(e){return[parseInt(e.slice(1))-1,e.charCodeAt(0)-97]},e}(),f=function(){function e(e,t){this.player=this.createPlayer(e),this.coords=c.coords(t),this.counter=0,this.dp=e}return e.prototype.moved=function(){for(var e=!0,t=0;t<this.home.length;t++){var n=this.home[t][0]-6.5,r=this.home[t][1]-6.5,i=this.player.rotate(6.5,6.5,r,n),o=i[0],a=i[1];if(this.coords[1]===o&&this.coords[0]===a){e=!1;break}}return e},e.prototype.radius=function(){for(;!this.max||this.counter<this.max;)return this.counter++,{value:this.counter,done:!1};return this.counter=0,{value:void 0,done:!0}},e.prototype.createPlayer=function(e){switch(e.charAt(0)){case"w":return new s;case"g":return new a;case"b":return new i;case"r":return new o;case"d":return new u;default:return}},e}(),l=function(e){function r(t,n){var r=e.call(this,t,n)||this;return r.name="Knight",r.home=[[0,4],[0,9]],r.max=1,r}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return 2},function(e){return 1}),!0],[new n(function(e){return 2},function(e){return-1}),!0],[new n(function(e){return-2},function(e){return 1}),!0],[new n(function(e){return-2},function(e){return-1}),!0],[new n(function(e){return 1},function(e){return 2}),!0],[new n(function(e){return 1},function(e){return-2}),!0],[new n(function(e){return-1},function(e){return 2}),!0],[new n(function(e){return-1},function(e){return-2}),!0]]},r}(f),h=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Bishop",t.home=[[0,5],[0,8]],t}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return e}),!0],[new n(function(e){return e},function(e){return-e}),!0],[new n(function(e){return-e},function(e){return e}),!0],[new n(function(e){return-e},function(e){return-e}),!0]]},r}(f),d=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Queen",t.home=t.player instanceof s||t.player instanceof i?[[0,6]]:[[0,7]],t}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return 0}),!0],[new n(function(e){return-e},function(e){return 0}),!0],[new n(function(e){return 0},function(e){return e}),!0],[new n(function(e){return 0},function(e){return-e}),!0],[new n(function(e){return e},function(e){return e}),!0],[new n(function(e){return e},function(e){return-e}),!0],[new n(function(e){return-e},function(e){return e}),!0],[new n(function(e){return-e},function(e){return-e}),!0]]},r}(f),p=function(e){function r(t,n){var r=e.call(this,t,n)||this;return r.name="King",r.home=r.player instanceof s||r.player instanceof i?[[0,7]]:[[0,6]],r.max=1,r}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return 1},function(e){return 0}),!0],[new n(function(e){return-1},function(e){return 0}),!0],[new n(function(e){return 0},function(e){return 1}),!0],[new n(function(e){return 0},function(e){return-1}),!0],[new n(function(e){return 1},function(e){return 1}),!0],[new n(function(e){return 1},function(e){return-1}),!0],[new n(function(e){return-1},function(e){return 1}),!0],[new n(function(e){return-1},function(e){return-1}),!0]]},r}(f),v=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Rook",t.home=[[0,3],[0,10]],t}return t(r,e),r.prototype.moves=function(){return[]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return 0}),!0],[new n(function(e){return-e},function(e){return 0}),!0],[new n(function(e){return 0},function(e){return e}),!0],[new n(function(e){return 0},function(e){return-e}),!0]]},r}(f),m=function(e){function r(t,n){var r=e.call(this,t,n)||this;return r.name="Pawn",r.home=[[1,3],[1,4],[1,5],[1,6],[1,7],[1,8],[1,9],[1,10]],r.max=1,r}return t(r,e),r.prototype.moves=function(){return this.moved()?[[new n(function(e){return 0},function(e){return 1}),!0]]:[[new n(function(e){return 0},function(e){return 1}),!0],[new n(function(e){return 0},function(e){return 2}),!0]]},r.prototype.attacks=function(){return[[new n(function(e){return e},function(e){return e}),!0],[new n(function(e){return-e},function(e){return e}),!0]]},r}(f),y=function(){function e(){this.squares=[];for(var e=0;e<14;e++){this.squares[e]=[];for(var t=0;t<14;t++)this.squares[e][t]=new c(e,t)}}return e.prototype.square=function(e){var t=c.coords(e);return this.squares[t[0]][t[1]]},e.prototype.valid=function(e,t){return e>=0&&e<=13&&t>=0&&t<=13},e}(),g=function(){function e(){this.colours=["red","blue","yellow","green"],this.board=new y;var e=this.getUsername();this.username=e||"red"}return e.prototype.setOriginSquare=function(e){var t=this.getThisSquareElement(event.target).attributes["data-square"];if(t){var n=document.getElementById("four-player-username"),r=n.attributes.origin;r?r.value=t.value:n.setAttribute("origin",t.value)}},e.prototype.getOriginSquareElement=function(e){var t=document.getElementById("four-player-username").attributes.origin;if(t)return this.getSquareElement(e,t.value)},e.prototype.resetOriginSquareAndCleanSquares=function(){var e=document.getElementById("four-player-username");e.attributes.origin&&e.removeAttribute("origin");var t=this.getBoardElement();this.clearCandidatesFromSquares(t),this.cleanColouredSquares(t)},e.prototype.showMovesAndEnemies=function(e){if(this.username){var t=this.getBoardElement();if(t){var n=this.getOriginSquareElement(t);if(n){var r=this.getThisSquareElement(e);if(r){this.clearCandidatesFromSquares(t),this.cleanColouredSquares(t),this.createBoard(t);var i=n.attributes["data-square"];if(i){var o=this.board.square(i.value);o.piece&&o.piece.player.name.toLowerCase()===this.username&&(this.analyseSquares(t),this.colouriseSquares(t,n,r))}}}}}},e.prototype.showHangingPieces=function(){if(this.username){var e=this.getBoardElement();e&&(this.clearCandidatesFromSquares(e),this.cleanColouredSquares(e),this.createBoard(e),this.analyseSquares(e),this.colouriseSquaresWithHangingPieces(e))}},e.prototype.getThisSquareElement=function(e){var t;if(e instanceof HTMLElement&&(-1!==e.className.indexOf("piece-")&&(t=e.parentElement),t||(t=e),-1!==t.className.indexOf("square-")))return t},e.prototype.getBoardElement=function(){for(var e,t=document.body.getElementsByTagName("div"),n=0;n<t.length;n++)if(0===t[n].className.indexOf("board-")){var r=t[n];if(r instanceof HTMLElement){e=r;break}}return e},e.prototype.cleanColouredSquares=function(e){var t=document.getElementById("four-player-username"),n=t.attributes.modifications;if(n){var r=e.children;if(!(r.length<14)){for(var i=n.value.split(","),o=0;o<i.length;o++)e:for(var a=0;a<14;a++)for(var u=0;u<14;u++){var s=r[a].children[u],c=s.attributes["data-square"];if(c&&s instanceof HTMLElement&&c.value===i[o]){s.style.backgroundColor=null;break e}}t.removeAttribute("modifications")}}},e.prototype.clearCandidatesFromSquares=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var i=t[n].children[r];i.attributes.attacks&&i.removeAttribute("attacks"),i.attributes.moves&&i.removeAttribute("moves")}},e.prototype.createBoard=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var i=t[n].children[r];if(i instanceof HTMLElement){var o=i.attributes["data-square"];if(o){var a=this.board.square(o.value),u=this.getPieceElement(i.children);if(u){var s=u.attributes["data-piece"];s&&(a.piece=this.createPiece(s.value,o.value))}}}}},e.prototype.createPiece=function(e,t){switch(e.charAt(1)){case"R":return new v(e,t);case"P":return new m(e,t);case"K":return new p(e,t);case"Q":case"D":return new d(e,t);case"B":return new h(e,t);case"N":return new l(e,t);default:return}},e.prototype.analyseSquares=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var i=t[n].children[r];if(i instanceof HTMLElement){var o=i.attributes["data-square"];if(o){var a=this.board.square(o.value);if(a.accessible()){var s=a.piece;s&&(s.player instanceof u||this.checkRadius(e,a))}}}}},e.prototype.checkRadius=function(e,t){this.checkAttackRadius(e,t),this.checkMoveRadius(e,t)},e.prototype.checkAttackRadius=function(e,t){for(var n=t.piece,r=n.attacks(),i=n.radius();!i.done&&i.value<=14&&this.remaining(r)>0;){for(var o=0;o<r.length;o++)this.checkAttackVector(e,t,r[o],i.value);i=n.radius()}},e.prototype.checkMoveRadius=function(e,t){for(var n=t.piece,r=n.moves(),i=n.radius();!i.done&&i.value<=14&&this.remaining(r)>0;){for(var o=0;o<r.length;o++)this.checkMoveVector(e,t,r[o],i.value);i=n.radius()}},e.prototype.checkAttackVector=function(e,t,n,r){if(n[1]){var i=n[0].x1(r),o=n[0].y1(r),a=t.piece.player.rotate(t.n,t.m,i,o),u=a[0],s=a[1];if(!this.board.valid(u,s))return void(n[1]=!1);var c=this.board.squares[s][u];if(!c.accessible())return void(n[1]=!1);this.setAttackCandidate(e,t,c),c.piece&&(n[1]=!1)}},e.prototype.checkMoveVector=function(e,t,n,r){if(n[1]){var i=n[0].x1(r),o=n[0].y1(r),a=t.piece.player.rotate(t.n,t.m,i,o),u=a[0],s=a[1];if(!this.board.valid(u,s))return void(n[1]=!1);var c=this.board.squares[s][u];if(!c.accessible())return void(n[1]=!1);c.piece?n[1]=!1:this.setMoveCandidate(e,t,c)}},e.prototype.setAttackCandidate=function(e,t,n){var r=this.getSquareElement(e,n.code());if(r){var i=r.attributes.attacks;i?i.value=i.value+","+t.code():r.setAttribute("attacks",t.code())}},e.prototype.setMoveCandidate=function(e,t,n){var r=this.getSquareElement(e,n.code());if(r){var i=r.attributes.moves;i?i.value=i.value+","+t.code():r.setAttribute("moves",t.code())}},e.prototype.getSquareElement=function(e,t){var n=e.children;if(!(n.length<14)){var r;e:for(var i=0;i<14;i++)for(var o=0;o<14;o++){var a=n[i].children[o];if(a instanceof HTMLElement&&a.classList.contains("square-"+t)){r=a;break e}}return r}},e.prototype.isTargetSquareValid=function(e,t,n){if(e.children.length<14)return!1;var r=t.attributes["data-square"];if(!r)return!1;var i,o=this.board.square(r.value).piece;if(!o)return!1;if(o.moves().length>0){var a=n.attributes.moves;if(!a)return!1;i=a.value.split(",")}else{var u=n.attributes.attacks;if(!u)return!1;i=u.value.split(",")}return 0!==i.length&&-1!==i.indexOf(r.value)},e.prototype.colouriseSquares=function(e,t,n){var r=e.children;r.length<14||(this.colouriseMovementSquares(r,e,t),this.isTargetSquareValid(e,t,n)&&this.colouriseEnemySquares(r,n))},e.prototype.colouriseMovementSquares=function(e,t,n){var r=n.attributes["data-square"];if(r){var i=this.board.square(r.value).piece;if(i)for(var o=0;o<14;o++)for(var a=0;a<14;a++){var u=e[o].children[a],s=u.attributes["data-square"];if(s&&u instanceof HTMLElement){var c=this.board.square(s.value);if(!c.piece||c.piece.player.name.toLowerCase()!==this.username){var f=void 0;if(0!==i.moves().length){var l=u.attributes.moves;if(!l)continue;f=l.value.split(",")}else{var h=u.attributes.attacks;if(!h)continue;f=h.value.split(",")}if(0!==f.length&&-1!==f.indexOf(r.value)){var d=[],p=u.attributes.attacks;p&&(d=p.value.split(","));var v=d.indexOf(r.value);-1!==v&&d.splice(v,1);var m=this.isFriendlySquare(t,d),y=this.getColour(u,m);u.style.backgroundColor=y,this.addCodeToModifiedSquares(s.value)}}}}}},e.prototype.colouriseEnemySquares=function(e,t){var n=t.attributes.attacks;if(n){var r=n.value.split(",");if(0!=r.length){var i=t.attributes["data-square"];if(i){var o=r.indexOf(i.value);-1!==o&&r.splice(o,1);for(var a=0;a<r.length;a++)e:for(var u=0;u<14;u++)for(var s=0;s<14;s++){var c=e[u].children[s],f=c.attributes["data-square"];if(f&&c instanceof HTMLElement&&f.value===r[a]){var l=this.board.square(f.value).piece;if(l&&l.player.name.toLowerCase()!==this.username){var h=this.getColour(c,!1);c.style.backgroundColor=h,this.addCodeToModifiedSquares(f.value);break e}}}}}}},e.prototype.colouriseSquaresWithHangingPieces=function(e){var t=e.children;if(!(t.length<14))for(var n=0;n<14;n++)for(var r=0;r<14;r++){var i=t[n].children[r],o=i.attributes["data-square"];if(o&&i instanceof HTMLElement){var a=this.board.square(o.value).piece;if(a){var u=i.attributes.attacks;if(u){var s=u.value.split(","),c=this.doesSquareHaveHangingPiece(e,a.player,s);if(c){var f=this.getColour(i,!c);i.style.backgroundColor=f}}}}}},e.prototype.doesSquareHaveHangingPiece=function(e,t,n){var r=e.children;if(r.length<14)return!1;for(var i=0;i<n.length;i++)for(var o=0;o<14;o++)for(var a=0;a<14;a++){var u=r[o].children[a],s=u.attributes["data-square"];if(s&&u instanceof HTMLElement&&s.value===n[i]){var c=this.board.square(s.value).piece;if(c&&c.player.name===t.name)return!0}}return!1},e.prototype.isFriendlySquare=function(e,t){var n=e.children;if(n.length<14)return!1;for(var r=0,i=0,o=0;o<t.length;o++)for(var a=0;a<14;a++)for(var u=0;u<14;u++){var s=n[a].children[u],c=s.attributes["data-square"];if(c&&s instanceof HTMLElement&&c.value===t[o]){var f=this.board.square(c.value).piece;f&&(f.player.name.toLowerCase()===this.username?r++:i++)}}return 0===r&&0===i||r>i},e.prototype.getColour=function(e,t){var n,r=window.getComputedStyle(e,null).getPropertyValue("background-color");if(0===r.indexOf("#")&&(n=this.hexToRgb(r)),0===r.indexOf("rgb")){var i=r.substring(4,r.length-1).split(", ");n={r:parseInt(i[0]),g:parseInt(i[1]),b:parseInt(i[2])}}return t?"rgb("+n.r+", 255, "+n.b+")":"rgb(255, "+n.g+", "+n.b+")"},e.prototype.addCodeToModifiedSquares=function(e){var t=document.getElementById("four-player-username"),n=t.attributes.modifications;n?n.value=n.value+","+e:t.setAttribute("modifications",e)},e.prototype.show=function(){for(var e=0;e<14;e++){for(var t=["|"],n=0;n<14;n++){var r=this.board.squares[e][n];r.accessible()?t.push(r.piece?r.piece.dp:"[]"):t.push("  ")}t.push("|");var i=this.board.squares;console.log(t.join(" ")+"%O %O %O %O %O %O %O %O %O %O %O %O %O %O |",i[e][0],i[e][1],i[e][2],i[e][3],i[e][4],i[e][5],i[e][6],i[e][7],i[e][8],i[e][9],i[e][10],i[e][11],i[e][12],i[e][13])}},e.prototype.getUsername=function(){for(var e=document.getElementById("four-player-username").innerText,t=document.body.getElementsByClassName("player-avatar"),n=0;n<t.length;n++){var r=t[n];if(r instanceof HTMLAnchorElement&&-1!==r.href.indexOf(e))for(var i=r.parentElement,o=0;o<i.classList.length;o++)for(var a=0;a<this.colours.length;a++)if(this.colours[a]===i.classList[o])return this.colours[a]}},e.prototype.hexToRgb=function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,n,r){return t+t+n+n+r+r});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},e.prototype.remaining=function(e){for(var t=0,n=0;n<e.length;n++)e[n][1]&&t++;return t},e.prototype.getPieceElement=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&0===n.className.indexOf("piece-"))return n}},e}(),b=function(){function e(){this.counter=60,this.enabled=!1,this.utterances=[60]}return e.prototype.username=function(){return document.getElementById("four-player-username").innerText},e.prototype.avatar=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&n.classList.contains("player-avatar"))return n}},e.prototype.current=function(e){return parseFloat(e.oldValue.trim().split(":")[1])},e.prototype.reset=function(e){if("childList"===e.type&&e.target instanceof HTMLDivElement&&0===e.target.classList.length&&1===e.addedNodes.length){var t=e.addedNodes[0];if(t instanceof HTMLElement&&t.classList.contains("modal-container"))t.querySelector(".game-over-container")&&(this.utterances=[60],this.counter=60)}},e.prototype.words=function(){return this.counter<=5?this.counter.toString():this.counter+" seconds left"},e.prototype.utterance=function(){return this.rate(new SpeechSynthesisUtterance(this.words()))},e.prototype.rate=function(e){return e.rate=1.8,e},e.prototype.utter=function(e){if(this.enabled&&"characterData"===e.type){var t=e.target.parentNode.parentNode;if(t&&t instanceof HTMLElement&&t.classList.contains("player-clock-timer")){var n=this.avatar(t.children);if(n&&n instanceof HTMLAnchorElement&&n.pathname==="/member/"+this.username()){var r=this.current(e);this.counter-r>0&&this.counter-r<=1&&(this.counter=r),(this.counter<=5&&this.counter%1==0||this.counter>5&&this.counter%5==0)&&this.counter!==this.utterances[0]&&(window.speechSynthesis.speak(this.utterance()),this.utterances.unshift(this.counter))}}}},e}(),w=function(){function e(){this.countdown=new b,this.init={characterDataOldValue:!0,attributeOldValue:!0,characterData:!0,attributes:!0,childList:!0,subtree:!0},this.createDocumentBodyObserverSubscription(),this.observer.observe(document.body,this.init)}return e.prototype.createDocumentBodyObserverSubscription=function(){var e=this;this.observer=new MutationObserver(function(t){(new g).showHangingPieces(),t.forEach(function(t){e.countdown.reset(t),e.countdown.utter(t)})})},e}();new(function(){function e(){document.body.addEventListener("mouseover",this.over),document.body.addEventListener("mousedown",this.down),document.body.addEventListener("mouseup",this.up),window.addEventListener("keydown",function(e){(!e.repeat&&"q"===e.key||"Q"===e.key)&&console.log("q key pressed")}),window.addEventListener("keyup",function(e){"q"!==e.key&&"Q"!==e.key||console.log("q key released")}),this.domWatcher=new w,this.rightAlignStartButton(),this.addStartAiButton()}return e.prototype.addStartAiButton=function(){var e=this,t=document.getElementsByClassName("btns-container")[0];if(t instanceof HTMLElement){t.style.cssFloat="right";var n=t.cloneNode(!0);if(n instanceof HTMLElement){n.style.cssFloat="left",n.style.marginRight="12px";var r=n.firstChild;"A"===r.nodeName&&r instanceof HTMLElement&&(r.innerText="Start AI",r.classList.remove("new-game-btn"));var i=n.cloneNode(!0);if(i instanceof HTMLElement){i.style.display="none";var o=i.firstChild;"A"===o.nodeName&&o instanceof HTMLElement&&(o.innerText="Stop AI",o.style.color="#b4b4b3",o.style.borderBottom="#272422",o.style.backgroundColor="#272422",o.addEventListener("click",function(){e.domWatcher.countdown.enabled=!1,i.style.display="none",n.style.display="block"})),r.addEventListener("click",function(){e.domWatcher.countdown.enabled=!0,i.style.display="block",n.style.display="none"})}t.parentNode.appendChild(n),t.parentNode.appendChild(i)}}return this},e.prototype.rightAlignStartButton=function(){var e=document.getElementsByTagName("head")[0];if(e instanceof HTMLElement){var t=document.createTextNode(".btns-container { float: right; }"),n=document.createElement("style");n instanceof HTMLElement&&(n.type="text/css",n.appendChild(t)),e.appendChild(n)}return this},e.prototype.over=function(e){(new g).showMovesAndEnemies(e.target)},e.prototype.down=function(e){var t=new g;t.setOriginSquare(e.target),t.showMovesAndEnemies(e.target)},e.prototype.up=function(e){var t=new g;t.resetOriginSquareAndCleanSquares(),t.showHangingPieces()},e}())}();
