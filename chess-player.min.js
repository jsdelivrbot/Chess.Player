!function(){"use strict";var e=function(){function e(){this.counter=60,this.enabled=!1,this.utterances=[60]}return e.prototype.username=function(){return document.getElementById("four-player-username").innerText},e.prototype.avatar=function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n instanceof HTMLElement&&n.classList.contains("player-avatar"))return n}},e.prototype.current=function(e){return parseFloat(e.oldValue.trim().split(":")[1])},e.prototype.reset=function(e){if("childList"===e.type&&e.target instanceof HTMLDivElement&&0===e.target.classList.length&&1===e.addedNodes.length){var t=e.addedNodes[0];if(t instanceof HTMLElement&&t.classList.contains("modal-container"))t.querySelector(".game-over-container")&&(this.utterances=[60],this.counter=60)}},e.prototype.words=function(){return this.counter<=5?this.counter.toString():this.counter+" seconds left"},e.prototype.utterance=function(){return this.rate(new SpeechSynthesisUtterance(this.words()))},e.prototype.rate=function(e){return e.rate=1.8,e},e.prototype.utter=function(e){if(this.enabled&&"characterData"===e.type){var t=e.target.parentNode.parentNode;if(t&&t instanceof HTMLElement&&t.classList.contains("player-clock-timer")){var n=this.avatar(t.children);if(n&&n instanceof HTMLAnchorElement&&n.pathname==="/member/"+this.username()){var r=this.current(e);this.counter-r>0&&this.counter-r<=1&&(this.counter=r),(this.counter<=5&&this.counter%1==0||this.counter>5&&this.counter%5==0)&&this.counter!==this.utterances[0]&&(window.speechSynthesis.speak(this.utterance()),this.utterances.unshift(this.counter))}}}},e}(),t=function(){function e(){}return e.prototype.getColour=function(e,t){var n,r=window.getComputedStyle(e,null).getPropertyValue("background-color");if(0===r.indexOf("#")&&(n=this.hexToRgb(r)),0===r.indexOf("rgb")){var o=r.substring(4,r.length-1).split(", ");n={r:parseInt(o[0]),g:parseInt(o[1]),b:parseInt(o[2])}}return t?"rgb("+n.r+", 255, "+n.b+")":"rgb(255, "+n.g+", "+n.b+")"},e.prototype.hexToRgb=function(e){e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(e,t,n,r){return t+t+n+n+r+r});var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},e}(),n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};function r(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var o=function(){function e(e){this.piece=e}return e.prototype.playing=function(){var e=this;if(this.piece.square.board.testing)return console.log(this.name.toLowerCase()),"red"===this.name.toLowerCase();var t=document.getElementById("four-player-username");return!!t&&[].slice.call(document.getElementsByClassName("player-avatar")).filter(function(e){return e instanceof HTMLAnchorElement}).filter(function(e){return-1!==e.href.indexOf(t.innerText)}).map(function(e){return e.parentElement}).some(function(t){return[].slice.call(t.classList).some(function(t){return t===e.name.toLowerCase})})},e}(),i=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Dead",t.turn=0,t}return r(t,e),t.prototype.pivot=function(){throw new Error("Not implemented")},t.prototype.rotate=function(e,t){throw new Error("Not implemented")},t}(o),u=function(){return function(e,t){this.x1=e,this.y1=t}}(),a=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Yellow",t.turn=3,t}return r(t,e),t.prototype.pivot=function(){return[this.piece.square.x,13-this.piece.square.y]},t.prototype.rotate=function(e,t){return[this.piece.square.x-e.x1(t),this.piece.square.y-e.y1(t)]},t}(o),c=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Green",t.turn=4,t}return r(t,e),t.prototype.pivot=function(){return[this.piece.square.y,13-this.piece.square.x]},t.prototype.rotate=function(e,t){return[this.piece.square.x-e.y1(t),this.piece.square.y+e.x1(t)]},t}(o),s=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Blue",t.turn=2,t}return r(t,e),t.prototype.pivot=function(){return[13-this.piece.square.y,this.piece.square.x]},t.prototype.rotate=function(e,t){return[this.piece.square.x+e.y1(t),this.piece.square.y-e.x1(t)]},t}(o),f=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Red",t.turn=1,t}return r(t,e),t.prototype.pivot=function(){return[this.piece.square.x,this.piece.square.y]},t.prototype.rotate=function(e,t){return[this.piece.square.x+e.x1(t),this.piece.square.y+e.y1(t)]},t}(o),l=function(){function e(e,t){this.player=this.createPlayer(e),this.candidates={attacks:[],moves:[]},this.square=t,this.code=e}return e.prototype.moved=function(){var e=this.player.pivot();return this.home.every(function(t){return e[0]!==t[0]||e[1]!==t[1]})},e.prototype.createPlayer=function(e){switch(e.charAt(0)){case"w":return new f(this);case"g":return new s(this);case"b":return new a(this);case"r":return new c(this);case"d":return new i(this);default:return}},e.prototype.scale=function(e,t,n){if(!this.max||t<=this.max){var r=this.player.rotate(e,t),o=r[0],i=r[1];this.square.board.squares.filter(function(e){return e.x===o&&e.y===i}).forEach(function(r){return n(e,t,r)})}},e.prototype.createCandidates=function(){var e=this,t=function t(n,r,o){o.piece||(o.candidates.moves.push(e),e.candidates.moves.push(o),e.scale(n,r+1,t))},n=function t(n,r,o){e.candidates.attacks.push(o),o.candidates.attacks.push(e),o.piece||e.scale(n,r+1,t)};this.moves().forEach(function(n){return e.scale(n,1,t)}),this.attacks().forEach(function(t){return e.scale(t,1,n)})},e.prototype.colouriseCandidates=function(){var e=this,t=function(t){console.group("colourise: %s",t.code);var n=t.candidates.attacks.filter(function(t){return t.square.code!==e.square.code});console.log("others: %s",n.map(function(e){return e.player.name+" "+e.name+" ("+e.square.code+")"}).join(", "));var r=n.filter(function(e){return e.player.playing()});console.log("allies: %s",r.map(function(e){return e.player.name+" "+e.name+" ("+e.square.code+")"}).join(", "));var o=n.filter(function(e){return!e.player.playing()});console.log("enemies: %s",o.map(function(e){return e.player.name+" "+e.name+" ("+e.square.code+")"}).join(", ")),t.element.classList.add("cp-mod"),t.element.style.backgroundColor=t.board.colourHelper.getColour(t.element,r.length>=o.length),console.log("allies: %i, enemies: %i",r.length,o.length),console.groupEnd()};this.candidates.moves.length>0?this.candidates.moves.filter(function(e){return!e.hasPiece()||!e.piece.player.playing()}).forEach(t):this.candidates.attacks.filter(function(e){return!e.hasPiece()||!e.piece.player.playing()}).forEach(t)},e}(),p=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.name="Knight",r.home=[[4,0],[9,0]],r.max=1,r}return r(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[new u(function(e){return 2},function(e){return 1}),new u(function(e){return 2},function(e){return-1}),new u(function(e){return-2},function(e){return 1}),new u(function(e){return-2},function(e){return-1}),new u(function(e){return 1},function(e){return 2}),new u(function(e){return 1},function(e){return-2}),new u(function(e){return-1},function(e){return 2}),new u(function(e){return-1},function(e){return-2})]},t}(l),h=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Bishop",t.home=[[5,0],[8,0]],t}return r(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[new u(function(e){return e},function(e){return e}),new u(function(e){return e},function(e){return-e}),new u(function(e){return-e},function(e){return e}),new u(function(e){return-e},function(e){return-e})]},t}(l),d=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Queen",t.home=t.player instanceof f||t.player instanceof a?[[6,0]]:[[7,0]],t}return r(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[new u(function(e){return e},function(e){return 0}),new u(function(e){return-e},function(e){return 0}),new u(function(e){return 0},function(e){return e}),new u(function(e){return 0},function(e){return-e}),new u(function(e){return e},function(e){return e}),new u(function(e){return e},function(e){return-e}),new u(function(e){return-e},function(e){return e}),new u(function(e){return-e},function(e){return-e})]},t}(l),m=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.name="King",r.home=r.player instanceof f||r.player instanceof a?[[7,0]]:[[6,0]],r.max=1,r}return r(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[new u(function(e){return 1},function(e){return 0}),new u(function(e){return-1},function(e){return 0}),new u(function(e){return 0},function(e){return 1}),new u(function(e){return 0},function(e){return-1}),new u(function(e){return 1},function(e){return 1}),new u(function(e){return 1},function(e){return-1}),new u(function(e){return-1},function(e){return 1}),new u(function(e){return-1},function(e){return-1})]},t}(l),y=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.name="Rook",t.home=[[3,0],[10,0]],t}return r(t,e),t.prototype.moves=function(){return[]},t.prototype.attacks=function(){return[new u(function(e){return e},function(e){return 0}),new u(function(e){return-e},function(e){return 0}),new u(function(e){return 0},function(e){return e}),new u(function(e){return 0},function(e){return-e})]},t}(l),v=function(e){function t(t,n){var r=e.call(this,t,n)||this;return r.name="Pawn",r.home=[[3,1],[4,1],[5,1],[6,1],[7,1],[8,1],[9,1],[10,1]],r.max=1,r}return r(t,e),t.prototype.moves=function(){return this.moved()?[new u(function(e){return 0},function(e){return 1})]:[new u(function(e){return 0},function(e){return 1}),new u(function(e){return 0},function(e){return 2})]},t.prototype.attacks=function(){return[new u(function(e){return e},function(e){return e}),new u(function(e){return-e},function(e){return e})]},t}(l),g=function(){function e(e,t){if(this.board=e,this.candidates={attacks:[],moves:[]},t instanceof HTMLDivElement){this.element=t;var n=t.attributes["data-square"];n&&(this.code=n.value,this.y=parseInt(this.code.slice(1))-1,this.x=this.code.charCodeAt(0)-97,this.piece=this.createPiece(),this.valid=[].slice.call(t.classList).every(function(e){return-1===e.indexOf("blank-")}))}}return e.prototype.hasPiece=function(){return null!==this.piece&&void 0!==this.piece},e.prototype.createPiece=function(){var e=this;return[].slice.call(this.element.children).filter(function(e){return e instanceof HTMLElement&&0===e.className.indexOf("piece-")}).map(function(e){return e.attributes["data-piece"]}).filter(function(e){return null!==e&&void 0!==e}).map(function(e){return e.value}).map(function(t){switch(t.charAt(1)){case"R":return new y(t,e);case"P":return new v(t,e);case"K":return new m(t,e);case"Q":case"D":return new d(t,e);case"B":return new h(t,e);case"N":return new p(t,e)}})[0]},e.prototype.isEnclosed=function(){var e=this;return this.board.squares.filter(function(t){return 1===Math.abs(e.x-t.x)&&1===Math.abs(e.y-t.y)}).every(function(e){return e.hasPiece()})},e.prototype.isCovered=function(){var e=this;return this.board.squares.filter(function(e){return e.hasPiece()}).map(function(e){return e.piece}).filter(function(t){return t.player.name===e.piece.player.name}).some(function(t){return t.candidates.attacks.some(function(t){return t===e})})},e.prototype.colouriseAttackerSquares=function(){var e=this;this.candidates.attacks.filter(function(e){return!e.player.playing()}).map(function(e){return e.square}).forEach(function(t){t.element.classList.add("cp-mod"),t.element.style.backgroundColor=e.board.colourHelper.getColour(t.element,!1)})},e}(),w=function(){function e(){this.colourHelper=new t,this.testing=!0,this.createSquares(),this.cleanColouredSquares(),this.setCandidateSquares()}return e.prototype.createSquares=function(){var e=this;this.squares=[].slice.call([].slice.call(document.body.getElementsByTagName("div")).filter(function(e){return 0===e.className.indexOf("board-")})[0].children).reduce(function(e,t){return[].slice.call(t.children).filter(function(e){return 0===e.className.indexOf("square-")}).forEach(function(t){return e.push(t)}),e},[]).map(function(t){return new g(e,t)}).filter(function(e){return e.valid})},e.prototype.cleanColouredSquares=function(){this.squares.map(function(e){return e.element}).filter(function(e){return[].slice.call(e.classList).some(function(e){return-1!==e.indexOf("cp-mod")})}).forEach(function(e){e.style.backgroundColor=null,e.classList.remove("cp-mod")})},e.prototype.setCandidateSquares=function(){this.squares.filter(function(e){return e.hasPiece()}).map(function(e){return e.piece}).forEach(function(e){return e.createCandidates()})},e.prototype.colouriseSquaresWithHangingPieces=function(){var e=this;return this.squares.filter(function(e){return e.hasPiece()}).filter(function(e){return!(e.piece.player instanceof i)}).filter(function(e){return!e.isCovered()&&!e.isEnclosed()}).forEach(function(t){t.element.classList.add("cp-mod"),t.element.style.backgroundColor=e.colourHelper.getColour(t.element,!1)}),this},e}(),b=function(){function t(){this.countdown=new e,this.init={characterDataOldValue:!0,attributeOldValue:!0,characterData:!0,attributes:!0,childList:!0,subtree:!0},document.records=[],this.createDocumentBodyObserverSubscription(),this.observer.observe(document.body,this.init)}return t.prototype.createDocumentBodyObserverSubscription=function(){var e=this;this.observer=new MutationObserver(function(t){t.forEach(function(t){e.checkForBoardUpdate(t),e.countdown.reset(t),e.countdown.utter(t)})})},t.prototype.checkForBoardUpdate=function(e){document.records.push(e),"childList"===e.type&&e.target instanceof HTMLElement&&0===e.target.className.indexOf("board-")&&(new w).colouriseSquaresWithHangingPieces()},t}(),q=function(){function e(){}return e.prototype.getSquareCode=function(e){var t=this.getSquareElement(e);if(t){var n=t.attributes["data-square"];if(n)return n.value}},e.prototype.getSquareElement=function(e){return e instanceof Element?this.getSquareElementRecursive(e):void 0},e.prototype.getSquareElementRecursive=function(e){return[].slice.call(e.classList).every(function(e){return-1===e.indexOf("square-")})?e.parentElement?this.getSquareElementRecursive(e.parentElement):void 0:e},e.prototype.getOriginSquareCode=function(){var e=document.getElementById("four-player-username").attributes.origin;if(e)return e.value},e.prototype.setOriginSquare=function(e){var t=this.getSquareElement(event.target);if(t){var n=t.attributes["data-square"];if(n){var r=document.getElementById("four-player-username"),o=r.attributes.origin;return o?o.value=n.value:r.setAttribute("origin",n.value),n.value}}},e.prototype.resetOriginSquare=function(){var e=document.getElementById("four-player-username");e.attributes.origin&&e.removeAttribute("origin")},e}();new(function(){function e(){document.body.addEventListener("mouseover",this.over),document.body.addEventListener("mousedown",this.down),document.body.addEventListener("mouseup",this.up),this.domWatcher=new b,this.rightAlignStartButton(),this.addStartAiButton()}return e.prototype.addStartAiButton=function(){var e=this,t=document.getElementsByClassName("btns-container")[0];if(t instanceof HTMLElement){t.style.cssFloat="right";var n=t.cloneNode(!0);if(n instanceof HTMLElement){n.style.cssFloat="left",n.style.marginRight="12px";var r=n.firstChild;"A"===r.nodeName&&r instanceof HTMLElement&&(r.innerText="Start AI",r.classList.remove("new-game-btn"));var o=n.cloneNode(!0);if(o instanceof HTMLElement){o.style.display="none";var i=o.firstChild;"A"===i.nodeName&&i instanceof HTMLElement&&(i.innerText="Stop AI",i.style.color="#b4b4b3",i.style.borderBottom="#272422",i.style.backgroundColor="#272422",i.addEventListener("click",function(){e.domWatcher.countdown.enabled=!1,o.style.display="none",n.style.display="block"})),r.addEventListener("click",function(){e.domWatcher.countdown.enabled=!0,o.style.display="block",n.style.display="none"})}t.parentNode.appendChild(n),t.parentNode.appendChild(o)}}return this},e.prototype.rightAlignStartButton=function(){var e=document.getElementsByTagName("head")[0];if(e instanceof HTMLElement){var t=document.createTextNode(".btns-container { float: right; }"),n=document.createElement("style");n instanceof HTMLElement&&(n.type="text/css",n.appendChild(t)),e.appendChild(n)}return this},e.prototype.over=function(e){var t=new w;t.colouriseSquaresWithHangingPieces();var n=new q,r=n.getOriginSquareCode();if(r){var o=t.squares.filter(function(e){return e.code===r});1===o.length&&o[0].hasPiece()&&o[0].piece.colouriseCandidates();var i=n.getSquareCode(e.target);i&&i!==r&&t.squares.filter(function(e){return e.code===i}).map(function(e){return console.log(e.code),e}).map(function(e){return e.candidates.attacks.length>0&&console.log("attackers: %s",e.candidates.attacks.map(function(e){return e.player.name+" "+e.name+" ("+e.square.code+")"}).join(", ")),e}).map(function(e){return e.hasPiece()&&console.log("covered:%s enclosed:%s",e.isCovered(),e.isEnclosed()),e}).filter(function(e){return e.hasPiece()}).filter(function(e){return e.candidates.attacks.length>0}).forEach(function(e){return e.colouriseAttackerSquares()})}},e.prototype.down=function(e){var t=new w;t.colouriseSquaresWithHangingPieces();var n=(new q).setOriginSquare(e.target);if(n)t.squares.filter(function(e){return e.code===n}).filter(function(e){return e.hasPiece()}).filter(function(e){return e.piece.player.playing()}).forEach(function(e){return e.piece.colouriseCandidates()})},e.prototype.up=function(e){(new q).resetOriginSquare(),(new w).colouriseSquaresWithHangingPieces()},e}())}();
