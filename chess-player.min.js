!function(){"use strict";var t=function(){function t(){this.counter=60,this.enabled=!1,this.utterances=[60]}return t.prototype.username=function(){return document.getElementById("four-player-username").innerText},t.prototype.avatar=function(t){for(var e=0;e<t.length;e++){var n=t[e];if(n instanceof HTMLElement&&n.classList.contains("player-avatar"))return n}},t.prototype.current=function(t){return parseFloat(t.oldValue.trim().split(":")[1])},t.prototype.reset=function(t){if("childList"===t.type&&t.target instanceof HTMLDivElement&&0===t.target.classList.length&&1===t.addedNodes.length){var e=t.addedNodes[0];if(e instanceof HTMLElement&&e.classList.contains("modal-container"))e.querySelector(".game-over-container")&&(this.utterances=[60],this.counter=60)}},t.prototype.words=function(){return this.counter<=5?this.counter.toString():this.counter+" seconds left"},t.prototype.utterance=function(){return this.rate(new SpeechSynthesisUtterance(this.words()))},t.prototype.rate=function(t){return t.rate=1.8,t},t.prototype.utter=function(t){if(this.enabled&&"characterData"===t.type){var e=t.target.parentNode.parentNode;if(e&&e instanceof HTMLElement&&e.classList.contains("player-clock-timer")){var n=this.avatar(e.children);if(n&&n instanceof HTMLAnchorElement&&n.pathname==="/member/"+this.username()){var r=this.current(t);this.counter-r>0&&this.counter-r<=1&&(this.counter=r),(this.counter<=5&&this.counter%1==0||this.counter>5&&this.counter%5==0)&&this.counter!==this.utterances[0]&&(window.speechSynthesis.speak(this.utterance()),this.utterances.unshift(this.counter))}}}},t}(),e=function(){function t(){}return t.prototype.getColour=function(t,e){var n,r=window.getComputedStyle(t,null).getPropertyValue("background-color");if(0===r.indexOf("#")&&(n=this.hexToRgb(r)),0===r.indexOf("rgb")){var i=r.substring(4,r.length-1).split(", ");n={r:parseInt(i[0]),g:parseInt(i[1]),b:parseInt(i[2])}}return e?"rgb("+n.r+", 255, "+n.b+")":"rgb(255, "+n.g+", "+n.b+")"},t.prototype.hexToRgb=function(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,function(t,e,n,r){return e+e+n+n+r+r});var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null},t}(),n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])};function r(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var i=function(){function t(t){this.piece=t}return t.prototype.playing=function(){var t=this;if(this.piece.square.board.testing)return"red"===this.name.toLowerCase();var e=document.getElementById("four-player-username");return!!e&&[].slice.call(document.getElementsByClassName("player-avatar")).filter(function(t){return t instanceof HTMLAnchorElement}).filter(function(t){return-1!==t.href.indexOf(e.innerText)}).map(function(t){return t.parentElement}).some(function(e){return[].slice.call(e.classList).some(function(e){return e===t.name.toLowerCase})})},t}(),o=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Dead",e.turn=0,e}return r(e,t),e.prototype.pivot=function(){throw new Error("Not implemented")},e.prototype.rotate=function(t,e){throw new Error("Not implemented")},e}(i),u=function(){return function(t,e){this.x1=t,this.y1=e}}(),a=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Yellow",e.turn=3,e}return r(e,t),e.prototype.pivot=function(){return[this.piece.square.x,13-this.piece.square.y]},e.prototype.rotate=function(t,e){return[this.piece.square.x-t.x1(e),this.piece.square.y-t.y1(e)]},e}(i),c=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Green",e.turn=4,e}return r(e,t),e.prototype.pivot=function(){return[13-this.piece.square.y,this.piece.square.x]},e.prototype.rotate=function(t,e){return[this.piece.square.x-t.y1(e),this.piece.square.y+t.x1(e)]},e}(i),s=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Blue",e.turn=2,e}return r(e,t),e.prototype.pivot=function(){return[this.piece.square.y,13-this.piece.square.x]},e.prototype.rotate=function(t,e){return[this.piece.square.x+t.y1(e),this.piece.square.y-t.x1(e)]},e}(i),f=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Red",e.turn=1,e}return r(e,t),e.prototype.pivot=function(){return[this.piece.square.x,this.piece.square.y]},e.prototype.rotate=function(t,e){return[this.piece.square.x+t.x1(e),this.piece.square.y+t.y1(e)]},e}(i),l=function(){function t(t,e){this.player=this.createPlayer(t),this.candidates={attacks:[],moves:[]},this.square=e,this.code=t}return t.prototype.moved=function(){var t=this.player.pivot();return this.home.every(function(e){return t[0]!==e[0]&&t[1]!==e[1]})},t.prototype.createPlayer=function(t){switch(t.charAt(0)){case"w":return new f(this);case"g":return new s(this);case"b":return new a(this);case"r":return new c(this);case"d":return new o(this);default:return}},t.prototype.scale=function(t,e,n){if(!this.max||e<=this.max){var r=this.player.rotate(t,e),i=r[0],o=r[1];this.square.board.squares.filter(function(t){return t.x===i&&t.y===o}).forEach(function(r){return n(t,e,r)})}},t.prototype.createCandidates=function(){var t=this,e=function e(n,r,i){i.piece||(i.candidates.moves.push(t),t.candidates.moves.push(i),t.scale(n,r+1,e))},n=function e(n,r,i){t.candidates.attacks.push(i),i.candidates.attacks.push(t),i.piece||t.scale(n,r+1,e)};this.moves().forEach(function(n){return t.scale(n,1,e)}),this.attacks().forEach(function(e){return t.scale(e,1,n)})},t.prototype.colouriseCandidates=function(){this.candidates.moves.length>0?this.candidates.moves.filter(function(t){return!t.hasPiece()||!t.piece.player.playing()}).forEach(this.colouriseMovementSquares):this.candidates.attacks.filter(function(t){return!t.hasPiece()||!t.piece.player.playing()}).forEach(this.colouriseMovementSquares)},t.prototype.colouriseMovementSquares=function(t){var e=this,n=t.candidates.attacks.filter(function(t){return t!==e}).filter(function(t){return t.player.playing()}),r=t.candidates.attacks.filter(function(t){return t!==e}).filter(function(t){return!t.player.playing()});t.element.classList.add("cp-mod"),t.element.style.backgroundColor=t.board.colourHelper.getColour(t.element,n.length>=r.length)},t}(),p=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.name="Knight",r.home=[[4,0],[9,0]],r.max=1,r}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return 2},function(t){return 1}),new u(function(t){return 2},function(t){return-1}),new u(function(t){return-2},function(t){return 1}),new u(function(t){return-2},function(t){return-1}),new u(function(t){return 1},function(t){return 2}),new u(function(t){return 1},function(t){return-2}),new u(function(t){return-1},function(t){return 2}),new u(function(t){return-1},function(t){return-2})]},e}(l),h=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Bishop",e.home=[[5,0],[8,0]],e}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return t}),new u(function(t){return t},function(t){return-t}),new u(function(t){return-t},function(t){return t}),new u(function(t){return-t},function(t){return-t})]},e}(l),d=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Queen",e.home=e.player instanceof f||e.player instanceof a?[[6,0]]:[[7,0]],e}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return 0}),new u(function(t){return-t},function(t){return 0}),new u(function(t){return 0},function(t){return t}),new u(function(t){return 0},function(t){return-t}),new u(function(t){return t},function(t){return t}),new u(function(t){return t},function(t){return-t}),new u(function(t){return-t},function(t){return t}),new u(function(t){return-t},function(t){return-t})]},e}(l),m=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.name="King",r.home=r.player instanceof f||r.player instanceof a?[[7,0]]:[[6,0]],r.max=1,r}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return 1},function(t){return 0}),new u(function(t){return-1},function(t){return 0}),new u(function(t){return 0},function(t){return 1}),new u(function(t){return 0},function(t){return-1}),new u(function(t){return 1},function(t){return 1}),new u(function(t){return 1},function(t){return-1}),new u(function(t){return-1},function(t){return 1}),new u(function(t){return-1},function(t){return-1})]},e}(l),y=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="Rook",e.home=[[3,0],[10,0]],e}return r(e,t),e.prototype.moves=function(){return[]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return 0}),new u(function(t){return-t},function(t){return 0}),new u(function(t){return 0},function(t){return t}),new u(function(t){return 0},function(t){return-t})]},e}(l),v=function(t){function e(e,n){var r=t.call(this,e,n)||this;return r.name="Pawn",r.home=[[3,1],[4,1],[5,1],[6,1],[7,1],[8,1],[9,1],[10,1]],r.max=1,r}return r(e,t),e.prototype.moves=function(){return this.moved()?[new u(function(t){return 0},function(t){return 1})]:[new u(function(t){return 0},function(t){return 1}),new u(function(t){return 0},function(t){return 2})]},e.prototype.attacks=function(){return[new u(function(t){return t},function(t){return t}),new u(function(t){return-t},function(t){return t})]},e}(l),g=function(){function t(t,e){if(this.board=t,this.candidates={attacks:[],moves:[]},e instanceof HTMLDivElement){this.element=e;var n=e.attributes["data-square"];n&&(this.code=n.value,this.y=parseInt(this.code.slice(1))-1,this.x=this.code.charCodeAt(0)-97,this.piece=this.createPiece(),this.valid=[].slice.call(e.classList).every(function(t){return-1===t.indexOf("blank-")}))}}return t.prototype.hasPiece=function(){return null!==this.piece&&void 0!==this.piece},t.prototype.createPiece=function(){var t=this;return[].slice.call(this.element.children).filter(function(t){return t instanceof HTMLElement&&0===t.className.indexOf("piece-")}).map(function(t){return t.attributes["data-piece"]}).filter(function(t){return null!==t&&void 0!==t}).map(function(t){return t.value}).map(function(e){switch(e.charAt(1)){case"R":return new y(e,t);case"P":return new v(e,t);case"K":return new m(e,t);case"Q":case"D":return new d(e,t);case"B":return new h(e,t);case"N":return new p(e,t)}})[0]},t.prototype.isEnclosed=function(){var t=this;return this.board.squares.filter(function(e){return 1===Math.abs(t.x-e.x)&&1===Math.abs(t.y-e.y)}).every(function(t){return t.hasPiece()})},t.prototype.isCovered=function(){var t=this;return this.board.squares.filter(function(t){return t.hasPiece()}).map(function(t){return t.piece}).filter(function(e){return e.player.name===t.piece.player.name}).some(function(e){return e.candidates.attacks.some(function(e){return e===t})})},t.prototype.colouriseAttackerSquares=function(){var t=this;this.candidates.attacks.map(function(t){return t.square}).forEach(function(e){e.element.classList.add("cp-mod"),e.element.style.backgroundColor=t.board.colourHelper.getColour(e.element,!1)})},t}(),w=function(){function t(){this.colourHelper=new e,this.testing=!0,this.createSquares(),this.cleanColouredSquares(),this.setCandidateSquares()}return t.prototype.createSquares=function(){var t=this;this.squares=[].slice.call([].slice.call(document.body.getElementsByTagName("div")).filter(function(t){return 0===t.className.indexOf("board-")})[0].children).reduce(function(t,e){return[].slice.call(e.children).filter(function(t){return 0===t.className.indexOf("square-")}).forEach(function(e){return t.push(e)}),t},[]).map(function(e){return new g(t,e)}).filter(function(t){return t.valid})},t.prototype.cleanColouredSquares=function(){this.squares.map(function(t){return t.element}).filter(function(t){return[].slice.call(t.classList).some(function(t){return-1!==t.indexOf("cp-mod")})}).forEach(function(t){t.style.backgroundColor=null,t.classList.remove("cp-mod")})},t.prototype.setCandidateSquares=function(){this.squares.filter(function(t){return t.hasPiece()}).map(function(t){return t.piece}).forEach(function(t){return t.createCandidates()})},t.prototype.colouriseSquaresWithHangingPieces=function(){var t=this;return this.squares.filter(function(t){return t.hasPiece()}).filter(function(t){return!(t.piece.player instanceof o)}).filter(function(t){return!t.isCovered()&&!t.isEnclosed()}).forEach(function(e){e.element.classList.add("cp-mod"),e.element.style.backgroundColor=t.colourHelper.getColour(e.element,!1)}),this},t}(),b=function(){function e(){this.countdown=new t,this.init={characterDataOldValue:!0,attributeOldValue:!0,characterData:!0,attributes:!0,childList:!0,subtree:!0},document.records=[],this.createDocumentBodyObserverSubscription(),this.observer.observe(document.body,this.init)}return e.prototype.createDocumentBodyObserverSubscription=function(){var t=this;this.observer=new MutationObserver(function(e){e.forEach(function(e){t.checkForBoardUpdate(e),t.countdown.reset(e),t.countdown.utter(e)})})},e.prototype.checkForBoardUpdate=function(t){document.records.push(t),"childList"===t.type&&t.target instanceof HTMLElement&&0===t.target.className.indexOf("board-")&&(new w).colouriseSquaresWithHangingPieces()},e}(),q=function(){function t(){}return t.prototype.getSquareCode=function(t){var e=this.getSquareElement(t);if(e){var n=e.attributes["data-square"];if(n)return n.value}},t.prototype.getSquareElement=function(t){return t instanceof Element?this.getSquareElementRecursive(t):void 0},t.prototype.getSquareElementRecursive=function(t){return[].slice.call(t.classList).every(function(t){return-1===t.indexOf("square-")})?t.parentElement?this.getSquareElementRecursive(t.parentElement):void 0:t},t.prototype.getOriginSquareCode=function(){var t=document.getElementById("four-player-username").attributes.origin;if(t)return t.value},t.prototype.setOriginSquare=function(t){var e=this.getSquareElement(event.target);if(e){var n=e.attributes["data-square"];if(n){var r=document.getElementById("four-player-username"),i=r.attributes.origin;return i?i.value=n.value:r.setAttribute("origin",n.value),n.value}}},t.prototype.resetOriginSquare=function(){var t=document.getElementById("four-player-username");t.attributes.origin&&t.removeAttribute("origin")},t}();new(function(){function t(){document.body.addEventListener("mouseover",this.over),document.body.addEventListener("mousedown",this.down),document.body.addEventListener("mouseup",this.up),this.domWatcher=new b,this.rightAlignStartButton(),this.addStartAiButton()}return t.prototype.addStartAiButton=function(){var t=this,e=document.getElementsByClassName("btns-container")[0];if(e instanceof HTMLElement){e.style.cssFloat="right";var n=e.cloneNode(!0);if(n instanceof HTMLElement){n.style.cssFloat="left",n.style.marginRight="12px";var r=n.firstChild;"A"===r.nodeName&&r instanceof HTMLElement&&(r.innerText="Start AI",r.classList.remove("new-game-btn"));var i=n.cloneNode(!0);if(i instanceof HTMLElement){i.style.display="none";var o=i.firstChild;"A"===o.nodeName&&o instanceof HTMLElement&&(o.innerText="Stop AI",o.style.color="#b4b4b3",o.style.borderBottom="#272422",o.style.backgroundColor="#272422",o.addEventListener("click",function(){t.domWatcher.countdown.enabled=!1,i.style.display="none",n.style.display="block"})),r.addEventListener("click",function(){t.domWatcher.countdown.enabled=!0,i.style.display="block",n.style.display="none"})}e.parentNode.appendChild(n),e.parentNode.appendChild(i)}}return this},t.prototype.rightAlignStartButton=function(){var t=document.getElementsByTagName("head")[0];if(t instanceof HTMLElement){var e=document.createTextNode(".btns-container { float: right; }"),n=document.createElement("style");n instanceof HTMLElement&&(n.type="text/css",n.appendChild(e)),t.appendChild(n)}return this},t.prototype.over=function(t){var e=new w;e.colouriseSquaresWithHangingPieces();var n=new q,r=n.getOriginSquareCode();if(r){var i=e.squares.filter(function(t){return t.code===r});1===i.length&&i[0].hasPiece()&&i[0].piece.colouriseCandidates()}var o=n.getSquareCode(t.target);o&&e.squares.filter(function(t){return t.code===o}).map(function(t){return console.log(t.code),t}).map(function(t){return console.log("attackers: %s",t.candidates.attacks.map(function(t){return t.player.name+" "+t.name+" ("+t.square.code+")"}).join(", ")),t}).map(function(t){return t.hasPiece()&&console.log("covered:%s enclosed:%s",t.isCovered(),t.isEnclosed()),t}).filter(function(t){return t.candidates.attacks.length>0}).forEach(function(t){return t.colouriseAttackerSquares()})},t.prototype.down=function(t){var e=new w;e.colouriseSquaresWithHangingPieces();var n=(new q).setOriginSquare(t.target);if(n){var r=e.squares.filter(function(t){return t.code===n}).filter(function(t){return t.hasPiece()}).filter(function(t){return t.piece.player.playing()});1===r.length&&r[0].piece.colouriseCandidates()}},t.prototype.up=function(t){(new q).resetOriginSquare(),(new w).colouriseSquaresWithHangingPieces()},t}())}();
