var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(n,t){n.__proto__=t}||function(n,t){for(var e in t)t.hasOwnProperty(e)&&(n[e]=t[e])};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}(),Player=function(){function n(){}return n.create=function(n){switch(n.charAt(0)){case"w":return new Red;case"g":return new Blue;case"b":return new Yellow;case"r":return new Green;case"d":return new Dead;default:return}},n}(),Red=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.name="Red",t.turn=1,t}return __extends(t,n),t.prototype.transform=function(n,t){return[n,t]},t}(Player),Blue=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.name="Blue",t.turn=2,t}return __extends(t,n),t.prototype.transform=function(n,t){return[-t,n]},t}(Player),Yellow=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.name="Yellow",t.turn=3,t}return __extends(t,n),t.prototype.transform=function(n,t){return[-n,-t]},t}(Player),Green=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.name="Green",t.turn=4,t}return __extends(t,n),t.prototype.transform=function(n,t){return[t,-n]},t}(Player),Dead=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.name="Dead",t.turn=0,t}return __extends(t,n),t.prototype.transform=function(n,t){throw new Error("Not implemented")},t}(Player),Vector=function(){return function(n,t){this.dx=n,this.dy=t}}(),Radius=function(){function n(n){this.counter=0,this.max=n}return n.prototype.next=function(){return!this.max||this.max>=this.counter?(this.counter++,{value:this.counter,done:!1}):(this.counter=0,{value:void 0,done:!0})},n}(),Piece=function(){function n(n){this.player=Player.create(n),this.dp=n}return n.create=function(n){switch(n.charAt(1)){case"R":return new Rook(n);case"P":return new Pawn(n);case"K":return new King(n);case"Q":return new Queen(n);case"B":return new Bishop(n);case"N":return new Knight(n);default:return}},n}(),Rook=function(n){function t(t){var e=n.call(this,t)||this;return e.name="Rook",e.radius=new Radius,e.attack=[],e.mobility=[new Vector(function(n,t){return n+t},function(n){return n}),new Vector(function(n,t){return n-t},function(n){return n}),new Vector(function(n){return n},function(n,t){return n+t}),new Vector(function(n){return n},function(n,t){return n-t})],e}return __extends(t,n),t}(Piece),Pawn=function(n){function t(t){var e=n.call(this,t)||this;return e.name="Pawn",e.radius=new Radius(2),e.attack=[new Vector(function(n){return n+1},function(n){return n+1}),new Vector(function(n){return n-1},function(n){return n+1})],e.mobility=[new Vector(function(n){return n},function(n,t){return n+t})],e}return __extends(t,n),t}(Piece),King=function(n){function t(t){var e=n.call(this,t)||this;return e.name="King",e.radius=new Radius(1),e.attack=[],e.mobility=[new Vector(function(n){return n+1},function(n){return n}),new Vector(function(n){return n-1},function(n){return n}),new Vector(function(n){return n},function(n){return n+1}),new Vector(function(n){return n},function(n){return n-1}),new Vector(function(n){return n+1},function(n){return n+1}),new Vector(function(n){return n+1},function(n){return n-1}),new Vector(function(n){return n-1},function(n){return n+1}),new Vector(function(n){return n-1},function(n){return n-1})],e}return __extends(t,n),t}(Piece),Queen=function(n){function t(t){var e=n.call(this,t)||this;return e.name="Queen",e.radius=new Radius,e.attack=[],e.mobility=[new Vector(function(n,t){return n+t},function(n){return n}),new Vector(function(n,t){return n-t},function(n){return n}),new Vector(function(n){return n},function(n,t){return n+t}),new Vector(function(n){return n},function(n,t){return n-t}),new Vector(function(n,t){return n+t},function(n,t){return n+t}),new Vector(function(n,t){return n+t},function(n,t){return n-t}),new Vector(function(n,t){return n-t},function(n,t){return n+t}),new Vector(function(n,t){return n-t},function(n,t){return n-t})],e}return __extends(t,n),t}(Piece),Bishop=function(n){function t(t){var e=n.call(this,t)||this;return e.name="Bishop",e.radius=new Radius,e.attack=[],e.mobility=[new Vector(function(n,t){return n+t},function(n,t){return n+t}),new Vector(function(n,t){return n+t},function(n,t){return n-t}),new Vector(function(n,t){return n-t},function(n,t){return n+t}),new Vector(function(n,t){return n-t},function(n,t){return n-t})],e}return __extends(t,n),t}(Piece),Knight=function(n){function t(t){var e=n.call(this,t)||this;return e.name="Knight",e.radius=new Radius(1),e.attack=[],e.mobility=[new Vector(function(n){return n+2},function(n){return n+1}),new Vector(function(n){return n+2},function(n){return n-1}),new Vector(function(n){return n-2},function(n){return n+1}),new Vector(function(n){return n-2},function(n){return n-1}),new Vector(function(n){return n+1},function(n){return n+2}),new Vector(function(n){return n+1},function(n){return n-2}),new Vector(function(n){return n-1},function(n){return n+2}),new Vector(function(n){return n-1},function(n){return n-2})],e}return __extends(t,n),t}(Piece),Square=function(){function n(n,t){return this.m=n,this.n=t,this}return n.coords=function(n){return[parseInt(n.slice(1))-1,n.charCodeAt(0)-97]},n.prototype.char=function(n){return String.fromCharCode(n+97)},n.prototype.code=function(){return""+this.char(this.n)+(this.m+1)},n.prototype.accessible=function(){return this.m>=3&&this.m<=10&&this.n>=0&&this.n<=2||this.m>=0&&this.m<=13&&this.n>=3&&this.n<=10||this.m>=3&&this.m<=10&&this.n>=11&&this.n<=13},n}(),DiffSquare=function(n){function t(){return null!==n&&n.apply(this,arguments)||this}return __extends(t,n),t}(Square),AnalysisSquare=function(n){function t(){var t=null!==n&&n.apply(this,arguments)||this;return t.candidates=[],t}return __extends(t,n),t}(Square),Board=function(){function n(){this.squares=[];for(var n=0;n<14;n++){this.squares[n]=[];for(var t=0;t<14;t++)this.squares[n][t]=new Square(n,t)}}return n.prototype.square=function(n){var t=Square.coords(n);return this.squares[t[0]][t[1]]},n.prototype.valid=function(n,t){return n>=0&&n<=13&&t>=0&&t<=13},n}(),Diff=function(){function n(){this.deaths=[],this.captures=[],this.removals=[],this.additions=[],this.squares=[];for(var n=0;n<14;n++){this.squares[n]=[];for(var t=0;t<14;t++)this.squares[n][t]=new DiffSquare(n,t)}}return n.prototype.square=function(n){var t=DiffSquare.coords(n);return this.squares[t[0]][t[1]]},n}(),Analysis=function(){function n(){this.squares=[];for(var n=0;n<14;n++){this.squares[n]=[];for(var t=0;t<14;t++)this.squares[n][t]=new AnalysisSquare(n,t)}}return n.prototype.square=function(n){var t=AnalysisSquare.coords(n);return this.squares[t[0]][t[1]]},n}(),Turn=function(){return function(n){this.diff=new Diff,this.added=new Board,this.removed=new Board,this.analysis=new Analysis,this.index=n}}(),Factory=function(){function n(){this.turns=[]}return n.prototype.piece=function(n){for(var t=0;t<n.length;t++){var e=n[t];if(e instanceof HTMLElement&&0===e.className.indexOf("piece-"))return e}},n.prototype.createBoards=function(n,t){var e=t.removedNodes,r=t.addedNodes;if(r.length>=14&&e.length>=14)for(var i=0;i<14;i++)for(var u=0;u<14;u++){var o=r[i].childNodes[u],s=e[i].childNodes[u];if(o instanceof HTMLElement&&s instanceof HTMLElement){var a=this.piece(o.childNodes),c=this.piece(s.childNodes);if(a){var f=a.attributes["data-piece"],h=o.attributes["data-square"];if(f&&h){var d=Piece.create(f.value);n.added.square(h.value).piece=d}}if(c){f=c.attributes["data-piece"],h=s.attributes["data-square"];if(f&&h){d=Piece.create(f.value);n.removed.square(h.value).piece=d}}}}},n.prototype.createDiffBoard=function(n){for(var t=0;t<14;t++)for(var e=0;e<14;e++){var r=n.removed.squares[t][e],i=n.added.squares[t][e],u=n.diff.squares[t][e];!r.piece&&i.piece&&(n.diff.additions.push(i),u.piece=i.piece,u.change="+"),r.piece&&!i.piece&&(n.diff.removals.push(r),u.piece=r.piece,u.change="-"),r.piece&&i.piece&&r.piece.dp!==i.piece.dp&&(u.piece=i.piece,i.piece.player instanceof Dead?(n.diff.deaths.push(i),u.change="x"):(n.diff.captures.push(i),u.change="*"))}},n.prototype.process=function(n){for(var t=0,e=0,r=n;e<r.length;e++){var i=r[e];if("childList"===i.type&&i.target instanceof HTMLElement&&0===i.target.className.indexOf("board-")){var u=new Turn(++t);this.createBoards(u,i),this.createDiffBoard(u),this.turns.push(u)}}return this},n.prototype.analyse=function(){this.log=[];for(var n=1;n<this.turns.length;n++){this.log.push("turn:"+n);var t=new Analysis,e=this.turns[n],r=e.added;this.log.push("analysing");for(var i=0;i<14;i++)for(var u=0;u<14;u++){var o=r.squares[i][u];this.log.push("square:m["+o.m+"], n["+o.n+"]");var s=o.accessible();if(this.log.push("accessible:"+s),s){var a=o.piece;if(a){var c=a.player;if(this.log.push("piece:"+c.name+" "+a.name),!(c instanceof Dead)){var f=c.transform(u,i),h=f[0],d=f[1];this.log.push("x:"+h+", y:"+d);for(var l=0,p=a.mobility;l<p.length;l++){var v=p[l];this.log.push("begin move loop");for(var w=!1;;){this.log.push("begin radius loop");var y=a.radius.next();if(this.log.push("restricted:"+w),this.log.push("result.done:"+y.done),y.done||w){this.log.push("breaking out of radius loop");break}var m=y.value,g=v.dy(d,m),q=v.dx(h,m);if(this.log.push("radius:"+m+", dx:"+q+", dy:"+g),r.valid(q,g)){var _=r.squares[g][q];if(this.log.push("target:m["+_.m+"], n["+_.n+"]"),_.accessible()){var V=_.code(),x=t.square(V);this.log.push("code:"+V+", goal:m["+x.m+"], n["+x.n+"]"),x.candidates.push(a);var b=[];for(var P in x.candidates)b.push(c.name+" "+a.name);this.log.push("candidates:"+b.join(", ")),_.piece&&(w=!0,this.log.push("goal has a piece. restricted set to true"))}else w=!0,this.log.push("target not accessible. restricted set to true")}else w=!0,this.log.push("square not valid. restricted set to true");this.log.push("end radius loop")}this.log.push("end move loop")}}}}}e.analysis=t}return this},n.prototype.header=function(n){return"Index: "+n.index+"; Additions: "+n.diff.additions.length+"; Removals: "+n.diff.removals.length+"; Captures: "+n.diff.captures.length+"; Deaths: "+n.diff.deaths.length},n.prototype.show=function(n){for(var t=1;t<Math.min(this.turns.length,n);t++){var e=this.turns[t];console.group(this.header(e)),console.log("                                                                                                          0   1   2   3   4   5   6   7   8   9  10  11  12  13");for(var r=0;r<14;r++){for(var i=["|"],u=0;u<14;u++){var o=e.added.squares[r][u];i.push(o.piece?o.piece.dp:"[]")}i.push("|");for(u=0;u<14;u++){o=e.diff.squares[r][u];i.push(o.piece?o.piece.dp+o.change:"[ ]")}i.push("|");var s=e.analysis.squares;console.log(i.join(" ")+"%i %O %O %O %O %O %O %O %O %O %O %O %O %O %O |",r,s[r][0],s[r][1],s[r][2],s[r][3],s[r][4],s[r][5],s[r][6],s[r][7],s[r][8],s[r][9],s[r][10],s[r][11],s[r][12],s[r][13])}console.groupEnd()}return this},n}();